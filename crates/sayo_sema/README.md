# Sayo Semantic Analyzer (sayo_sema)

è¯­ä¹‰åˆ†æå™¨ç”¨äºæ£€æŸ¥ Sayo æ±‡ç¼–ä»£ç çš„è¯­ä¹‰é”™è¯¯ã€‚

## åŠŸèƒ½

### 1. æ ‡ç­¾ä½œç”¨åŸŸå’Œè·³è½¬éªŒè¯ ğŸ†•

æ£€æŸ¥æ ‡ç­¾å®šä¹‰å’Œå¼•ç”¨çš„æ­£ç¡®æ€§ï¼Œæ”¯æŒå…¨å±€æ ‡ç­¾å’Œå±€éƒ¨æ ‡ç­¾ä½œç”¨åŸŸã€‚

#### å…¨å±€æ ‡ç­¾ vs å±€éƒ¨æ ‡ç­¾

- **å…¨å±€æ ‡ç­¾**: ä¸å¸¦ `.` å‰ç¼€ï¼Œå¦‚ `main`, `function1`
- **å±€éƒ¨æ ‡ç­¾**: å¸¦ `.` å‰ç¼€ï¼Œå¦‚ `.loop`, `.done`
- å±€éƒ¨æ ‡ç­¾å¿…é¡»åœ¨å…¨å±€æ ‡ç­¾ä¹‹åå®šä¹‰ï¼Œå¹¶ç»‘å®šåˆ°æœ€è¿‘çš„å…¨å±€æ ‡ç­¾
- ä¸åŒå…¨å±€æ ‡ç­¾ä¸‹å¯ä»¥æœ‰åŒåçš„å±€éƒ¨æ ‡ç­¾ï¼ˆäº’ä¸å†²çªï¼‰

#### ä¸¤éæ‰«æ

1. **ç¬¬ä¸€é**: æ”¶é›†æ‰€æœ‰æ ‡ç­¾å®šä¹‰å’Œåœ°å€
2. **ç¬¬äºŒé**: éªŒè¯æ‰€æœ‰æ ‡ç­¾å¼•ç”¨æ˜¯å¦å­˜åœ¨

#### æ ‡ç­¾è§£æè§„åˆ™

- å¼•ç”¨å¸¦ `.` çš„æ ‡ç­¾ï¼šåªåœ¨å½“å‰å…¨å±€æ ‡ç­¾çš„å±€éƒ¨è¡¨ä¸­æŸ¥æ‰¾
- å¼•ç”¨ä¸å¸¦ `.` çš„æ ‡ç­¾ï¼šåªåœ¨å…¨å±€è¡¨ä¸­æŸ¥æ‰¾

#### ç«‹å³æ•°ä½œä¸ºåœ°å€

æ”¯æŒä½¿ç”¨ç«‹å³æ•°ï¼ˆ0-65535ï¼‰ä»£æ›¿æ ‡ç­¾ï¼Œå®ç°ç›´æ¥åœ°å€è·³è½¬ï¼š

```assembly
JMP 123         ; âœ“ è·³è½¬åˆ°åœ°å€ 123
CALL 1000       ; âœ“ è°ƒç”¨åœ°å€ 1000
JMP 70000       ; âœ— é”™è¯¯: åœ°å€å¿…é¡»åœ¨ 0-65535 èŒƒå›´å†…
```

#### ç¤ºä¾‹

```assembly
; å…¨å±€æ ‡ç­¾
main:
    MOV R0, 10
    JMP start           ; âœ“ æ­£ç¡®: è·³è½¬åˆ°å…¨å±€æ ‡ç­¾
    
start:
    CALL function1      ; âœ“ æ­£ç¡®: è°ƒç”¨å¦ä¸€ä¸ªå…¨å±€æ ‡ç­¾

; å±€éƒ¨æ ‡ç­¾ä½œç”¨åŸŸ
function1:
    MOV R0, 0
.loop:                  ; å±€éƒ¨æ ‡ç­¾ï¼Œå±äº function1
    INC R0
    JNZ R0, .loop       ; âœ“ æ­£ç¡®: å¼•ç”¨æœ¬å‡½æ•°çš„å±€éƒ¨æ ‡ç­¾
    JMP .done
.done:
    RET

; åŒåå±€éƒ¨æ ‡ç­¾åœ¨ä¸åŒä½œç”¨åŸŸ
function2:
    MOV R1, 10
.loop:                  ; âœ“ æ­£ç¡®: è¿™æ˜¯ function2 çš„ .loopï¼Œä¸ function1 çš„ä¸å†²çª
    DEC R1
    JNZ R1, .loop       ; âœ“ æ­£ç¡®: å¼•ç”¨æœ¬å‡½æ•°çš„ .loop
    RET

; é”™è¯¯ç¤ºä¾‹
error_test:
    JMP undefined       ; âœ— é”™è¯¯: æœªå®šä¹‰çš„æ ‡ç­¾ 'undefined'
    JMP .no_such        ; âœ— é”™è¯¯: æœªå®šä¹‰çš„å±€éƒ¨æ ‡ç­¾ '.no_such'

.orphan:                ; âœ— é”™è¯¯: å±€éƒ¨æ ‡ç­¾å¿…é¡»åœ¨å…¨å±€æ ‡ç­¾ä¹‹å
    NOP

duplicate:
    NOP
duplicate:              ; âœ— é”™è¯¯: é‡å¤çš„æ ‡ç­¾å®šä¹‰
    NOP
```

### 2. ç«‹å³æ•°èŒƒå›´æ£€æŸ¥

æ£€æŸ¥æŒ‡ä»¤ä¸­çš„ç«‹å³æ•°æ˜¯å¦åœ¨å…è®¸çš„èŒƒå›´å†…ã€‚æ”¯æŒä»¥ä¸‹ç±»å‹ï¼š

- `u8`: 0 - 255
- `i8`: -128 - 127
- `u16`: 0 - 65535
- `i16`: -32768 - 32767
- `u32`: 0 - 4294967295
- `i32`: -2147483648 - 2147483647

#### ç¤ºä¾‹

```assembly
SLEEP 200      ; âœ“ æ­£ç¡®: 200 åœ¨ u8 èŒƒå›´å†…
SLEEP 300      ; âœ— é”™è¯¯: 300 è¶…å‡º u8 èŒƒå›´ (0-255)
MOV16 R0, 1000 ; âœ“ æ­£ç¡®: 1000 åœ¨ u16 èŒƒå›´å†…
SJMP -50       ; âœ“ æ­£ç¡®: -50 åœ¨ i8 èŒƒå›´å†… (-128 åˆ° 127)
MOV8SX R0, -10 ; âœ“ æ­£ç¡®: MOV8SX ä½¿ç”¨ i8ï¼Œæ”¯æŒè´Ÿæ•°
```

### 3. åªè¯»å¯„å­˜å™¨æ£€æŸ¥

æ£€æŸ¥æŒ‡ä»¤æ˜¯å¦å°è¯•å†™å…¥åªè¯»å¯„å­˜å™¨ã€‚ä»¥ä¸‹å¯„å­˜å™¨æ˜¯åªè¯»çš„ï¼š

- `ZERO` - æ’ä¸º 0 çš„å¯„å­˜å™¨
- `*DPTR` - ROM å¯»å€ä¸“ç”¨å¯„å­˜å™¨
- `KEY_IO` - æŒ‰é”®çŠ¶æ€å¯„å­˜å™¨
- `SYS_TIME_MS` - ç³»ç»Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- `SYS_TIME_S` - ç³»ç»Ÿæ—¶é—´ï¼ˆç§’ï¼‰
- `SYS_KEY_COUNT` - ç‰©ç†æŒ‰é”®è®¡æ•°
- `SCRIPT_ADDR` - è„šæœ¬èµ·å§‹åœ°å€
- `CFG_ADDR` - é…ç½®æ–‡ä»¶åœ°å€
- `GL_SIZE` - å…¨å±€å¯„å­˜å™¨æ•°é‡

#### ç¤ºä¾‹

```assembly
MOV8 R0, 42     ; âœ“ æ­£ç¡®: R0 æ˜¯å¯å†™çš„
MOV8 ZERO, 42   ; âœ— é”™è¯¯: ZERO æ˜¯åªè¯»çš„
INC R1          ; âœ“ æ­£ç¡®: R1 æ˜¯å¯å†™çš„
INC KEY_IO      ; âœ— é”™è¯¯: KEY_IO æ˜¯åªè¯»çš„
```

### 4. æ“ä½œæ•°æ•°é‡æ£€æŸ¥ ğŸ†•

æ£€æŸ¥æŒ‡ä»¤çš„æ“ä½œæ•°æ•°é‡æ˜¯å¦æ­£ç¡®ã€‚

#### ç¤ºä¾‹

```assembly
ADD_R R0, R1, R2  ; âœ“ æ­£ç¡®: ADD_R éœ€è¦ 3 ä¸ªæ“ä½œæ•°
ADD_R R0, R1      ; âœ— é”™è¯¯: ADD_R éœ€è¦ 3 ä¸ªæ“ä½œæ•°ï¼Œä½†åªæä¾›äº† 2 ä¸ª
MOV8 R0, 42       ; âœ“ æ­£ç¡®: MOV8 éœ€è¦ 2 ä¸ªæ“ä½œæ•°
MOV8 R0           ; âœ— é”™è¯¯: MOV8 éœ€è¦ 2 ä¸ªæ“ä½œæ•°ï¼Œä½†åªæä¾›äº† 1 ä¸ª
```

### 5. æ“ä½œæ•°ç±»å‹æ£€æŸ¥ ğŸ†•

æ£€æŸ¥æ“ä½œæ•°ç±»å‹æ˜¯å¦ä¸æŒ‡ä»¤è¦æ±‚åŒ¹é…ã€‚

#### ç¤ºä¾‹

```assembly
MOV R0, R1        ; âœ“ æ­£ç¡®: ä¸¤ä¸ªæ“ä½œæ•°éƒ½æ˜¯å¯„å­˜å™¨
MOV R0, loop_start ; âœ— é”™è¯¯: ç¬¬äºŒä¸ªæ“ä½œæ•°åº”è¯¥æ˜¯å¯„å­˜å™¨ï¼Œä½†æä¾›äº†æ ‡ç­¾
SLEEP 100         ; âœ“ æ­£ç¡®: æ“ä½œæ•°æ˜¯ç«‹å³æ•°
SLEEP R0          ; âœ— é”™è¯¯: æ“ä½œæ•°åº”è¯¥æ˜¯ u8 ç«‹å³æ•°ï¼Œä½†æä¾›äº†å¯„å­˜å™¨
JMP loop_start    ; âœ“ æ­£ç¡®: æ“ä½œæ•°æ˜¯æ ‡ç­¾
JMP 1000          ; âœ“ æ­£ç¡®: ä¹Ÿå¯ä»¥ä½¿ç”¨ç«‹å³æ•°ï¼ˆ0-65535ï¼‰ä½œä¸ºåœ°å€
```

## ä½¿ç”¨æ–¹æ³•

```rust
use sayo_sema::SemanticChecker;
use sayo_ast::Program;

let mut checker = SemanticChecker::new();
let program: Program = /* è§£æåçš„ AST */;

match checker.check(&program) {
    Ok(()) => println!("è¯­ä¹‰æ£€æŸ¥é€šè¿‡"),
    Err(errors) => {
        for error in errors {
            eprintln!("é”™è¯¯: {}", error);
        }
    }
}
```

## é”™è¯¯ç±»å‹

### UndefinedLabel ğŸ†•

æœªå®šä¹‰çš„æ ‡ç­¾é”™è¯¯ã€‚

```
Undefined label 'undefined_label' at position 10:15
```

### DuplicateLabel ğŸ†•

é‡å¤å®šä¹‰çš„æ ‡ç­¾é”™è¯¯ã€‚

```
Duplicate label definition 'start' at position 20:25
```

### LocalLabelWithoutGlobal ğŸ†•

å±€éƒ¨æ ‡ç­¾åœ¨æ²¡æœ‰å…¨å±€æ ‡ç­¾ä¸Šä¸‹æ–‡æ—¶ä½¿ç”¨çš„é”™è¯¯ã€‚

```
Local label '.loop' used without a preceding global label at position 5:10
```

### ImmediateOutOfRange

ç«‹å³æ•°è¶…å‡ºèŒƒå›´é”™è¯¯ã€‚

```
Immediate value 300 out of range for type u8 at position 10:15
```

### WriteToReadOnlyRegister

å°è¯•å†™å…¥åªè¯»å¯„å­˜å™¨é”™è¯¯ã€‚

```
Cannot write to read-only register ZERO at position 20:5
```

### OperandCountMismatch ğŸ†•

æ“ä½œæ•°æ•°é‡ä¸åŒ¹é…é”™è¯¯ã€‚

```
ADD_R requires 3 operand(s), but 2 provided at position 15:10
```

### InvalidOperandType ğŸ†•

æ“ä½œæ•°ç±»å‹ä¸åŒ¹é…é”™è¯¯ã€‚

```
Invalid operand type for MOV: expected register, got label at position 25:12
```

## æ ‡ç­¾åˆ†æå™¨ API ğŸ†•

`LabelAnalyzer` æä¾›ä¸¤éæ‰«æçš„æ ‡ç­¾åˆ†æï¼š

```rust
use sayo_sema::LabelAnalyzer;
use sayo_ast::Program;

let mut analyzer = LabelAnalyzer::new();
let program: Program = /* è§£æåçš„ AST */;

match analyzer.analyze(&program) {
    Ok(()) => println!("æ ‡ç­¾åˆ†æé€šè¿‡"),
    Err(errors) => {
        for error in errors {
            eprintln!("é”™è¯¯: {}", error);
        }
    }
}
```

`LabelTable` æä¾›æ ‡ç­¾å­˜å‚¨å’Œè§£æï¼š

```rust
use sayo_sema::LabelTable;

let mut table = LabelTable::new();

// æ·»åŠ å…¨å±€æ ‡ç­¾
table.add_global_label("main".to_string(), 0);

// æ·»åŠ å±€éƒ¨æ ‡ç­¾ï¼ˆéœ€è¦åœ¨å…¨å±€æ ‡ç­¾ä¹‹åï¼‰
table.add_local_label(".loop".to_string(), 10);

// è§£ææ ‡ç­¾
match table.resolve("main") {
    Ok(address) => println!("main ä½äºåœ°å€ {}", address),
    Err(_) => println!("æ ‡ç­¾æœªå®šä¹‰"),
}

match table.resolve(".loop") {
    Ok(address) => println!(".loop ä½äºåœ°å€ {}", address),
    Err(_) => println!("å±€éƒ¨æ ‡ç­¾æœªå®šä¹‰æˆ–ä½œç”¨åŸŸé”™è¯¯"),
}
```

## LSP é›†æˆ ğŸ†•

è¯­ä¹‰åˆ†æå™¨å·²é›†æˆåˆ° `sayo-lsp` ä¸­ï¼Œæä¾›å®æ—¶çš„è¯­ä¹‰é”™è¯¯æ£€æŸ¥ï¼š

1. **å®æ—¶è¯Šæ–­**: åœ¨ç¼–è¾‘å™¨ä¸­å®æ—¶æ˜¾ç¤ºè¯­ä¹‰é”™è¯¯
2. **é”™è¯¯æ ‡è®°**: çº¢è‰²æ³¢æµªçº¿æ ‡è®°æœ‰é—®é¢˜çš„ä»£ç 
3. **é”™è¯¯ä¿¡æ¯**: é¼ æ ‡æ‚¬åœæŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯è¯´æ˜
4. **é”™è¯¯æ¥æº**: åŒºåˆ†è¯­æ³•é”™è¯¯ (`sayo-asm`) å’Œè¯­ä¹‰é”™è¯¯ (`sayo-asm-semantic`)

### VS Code ä¸­çš„ä½¿ç”¨

å®‰è£…å¹¶é…ç½® Sayo LSP æ‰©å±•åï¼Œè¯­ä¹‰æ£€æŸ¥ä¼šè‡ªåŠ¨è¿è¡Œï¼š

```assembly
; è¿™äº›é”™è¯¯ä¼šåœ¨ç¼–è¾‘å™¨ä¸­å®æ—¶æ˜¾ç¤º
SLEEP 300        ; çº¢è‰²æ³¢æµªçº¿: ç«‹å³æ•°è¶…å‡ºèŒƒå›´
MOV8 ZERO, 10    ; çº¢è‰²æ³¢æµªçº¿: åªè¯»å¯„å­˜å™¨
ADD_R R0, R1     ; çº¢è‰²æ³¢æµªçº¿: æ“ä½œæ•°æ•°é‡ä¸åŒ¹é…
JMP undefined    ; çº¢è‰²æ³¢æµªçº¿: æœªå®šä¹‰çš„æ ‡ç­¾
.orphan:         ; çº¢è‰²æ³¢æµªçº¿: å±€éƒ¨æ ‡ç­¾æ²¡æœ‰å…¨å±€ä¸Šä¸‹æ–‡
```

## æŒ‡ä»¤å…ƒæ•°æ®

æ¯ä¸ªæŒ‡ä»¤éƒ½æœ‰å…³è”çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ï¼š

- æ“ä½œç 
- æŒ‡ä»¤é•¿åº¦
- æ“ä½œæ•°å®šä¹‰ï¼ˆç±»å‹å’Œè¯»/å†™ä¿¡æ¯ï¼‰

**é‡è¦**: æ‰€æœ‰æŒ‡ä»¤éƒ½å¿…é¡»å®šä¹‰ metadataã€‚`metadata()` æ–¹æ³•ä¸å†ä½¿ç”¨é€šé…ç¬¦ `_`ï¼Œè¿™ç¡®ä¿äº†ï¼š
1. æ¯ä¸ªæ–°å¢çš„æŒ‡ä»¤éƒ½å¿…é¡»æ˜¾å¼å®šä¹‰å…¶ metadata
2. ç¼–è¯‘å™¨ä¼šåœ¨å¿˜è®°å®šä¹‰ metadata æ—¶æŠ¥é”™
3. è¯­ä¹‰æ£€æŸ¥å™¨èƒ½å‡†ç¡®éªŒè¯æ¯æ¡æŒ‡ä»¤çš„æ“ä½œæ•°æ•°é‡å’Œç±»å‹

ä¾‹å¦‚ï¼š

```rust
// MOV8 R0, 42
// ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼ˆR0ï¼‰æ˜¯å†™æ“ä½œ
// ç¬¬äºŒä¸ªæ“ä½œæ•°ï¼ˆ42ï¼‰æ˜¯è¯»æ“ä½œï¼ˆu8ç±»å‹ï¼‰
Mnemonic::MOV8.metadata()

// MOV8SX R0, -10
// ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼ˆR0ï¼‰æ˜¯å†™æ“ä½œ
// ç¬¬äºŒä¸ªæ“ä½œæ•°ï¼ˆ-10ï¼‰æ˜¯è¯»æ“ä½œï¼ˆi8ç±»å‹ï¼Œæ”¯æŒè´Ÿæ•°ï¼‰
Mnemonic::MOV8SX.metadata()

// JG R0, R1, loop_start
// ä¸‰ä¸ªæ“ä½œæ•°ï¼šä¸¤ä¸ªå¯„å­˜å™¨ï¼ˆè¯»ï¼‰å’Œä¸€ä¸ªæ ‡ç­¾ï¼ˆè¯»ï¼‰
Mnemonic::JG.metadata()
```

## å¯„å­˜å™¨å…ƒæ•°æ®

æ¯ä¸ªå¯„å­˜å™¨éƒ½æœ‰å…³è”çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ï¼š

- ç´¢å¼•ï¼ˆåœ¨å¯„å­˜å™¨æ–‡ä»¶ä¸­çš„ä½ç½®ï¼‰
- ä½å®½ï¼ˆ8ã€16ã€24æˆ–32ä½ï¼‰
- è®¿é—®æ¨¡å¼ï¼ˆR=åªè¯», W=åªå†™, RW=è¯»å†™ï¼‰

ä¾‹å¦‚ï¼š

```rust
// R0 æ˜¯ 32 ä½å¯è¯»å†™å¯„å­˜å™¨
Register::R0.metadata()

// ZERO æ˜¯ 8 ä½åªè¯»å¯„å­˜å™¨
Register::Zero.metadata()
```

## é›†æˆè¯´æ˜

è¿™ä¸ªè¯­ä¹‰åˆ†æå™¨è®¾è®¡ä¸ºåœ¨è¯­æ³•åˆ†æï¼ˆparsingï¼‰ä¹‹åè¿è¡Œï¼š

1. è¯æ³•åˆ†æï¼ˆLexingï¼‰
2. è¯­æ³•åˆ†æï¼ˆParsingï¼‰ -> ç”Ÿæˆ AST
3. **è¯­ä¹‰åˆ†æï¼ˆSemantic Analysisï¼‰** <- sayo_sema
4. ä»£ç ç”Ÿæˆæˆ–æ‰§è¡Œ

## æµ‹è¯•

è¿è¡Œæµ‹è¯•å¥—ä»¶ï¼š

```bash
cargo test -p sayo_sema
```

æ‰€æœ‰ 14 ä¸ªæµ‹è¯•åº”è¯¥é€šè¿‡ï¼ŒåŒ…æ‹¬ï¼š
- `test_immediate_in_range`
- `test_immediate_out_of_range`
- `test_write_to_read_only_register`
- `test_write_to_writable_register`
- `test_operand_count_mismatch` ğŸ†•
- `test_invalid_operand_type_register_expected` ğŸ†•
- `test_invalid_operand_type_immediate_expected` ğŸ†•
- `test_multiple_errors` ğŸ†•
- `label_analyzer::tests::test_global_label` ğŸ†•
- `label_analyzer::tests::test_local_label` ğŸ†•
- `label_analyzer::tests::test_undefined_label` ğŸ†•
- `label_analyzer::tests::test_duplicate_global_label` ğŸ†•
- `label_analyzer::tests::test_local_label_without_global` ğŸ†•
- `label_analyzer::tests::test_local_label_scope_isolation` ğŸ†•

## æ‰©å±•

æœªæ¥å¯èƒ½æ·»åŠ çš„è¯­ä¹‰æ£€æŸ¥ï¼š

- ~~æ ‡ç­¾é‡å¤å®šä¹‰æ£€æŸ¥~~ âœ… å·²å®ç°
- ~~æ ‡ç­¾æœªå®šä¹‰æ£€æŸ¥~~ âœ… å·²å®ç°
- ~~æ ‡ç­¾ä½œç”¨åŸŸæ£€æŸ¥ï¼ˆå…¨å±€/å±€éƒ¨ï¼‰~~ âœ… å·²å®ç°
- å¯„å­˜å™¨ç±»å‹æ£€æŸ¥ï¼ˆç¡®ä¿æ“ä½œæ•°å¤§å°åŒ¹é…ï¼‰
- æ§åˆ¶æµåˆ†æ
- æ•°æ®æµåˆ†æ
- æ­»ä»£ç æ£€æµ‹
- æ— é™å¾ªç¯æ£€æµ‹
