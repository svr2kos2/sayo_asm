# Sayo ASM æ±‡ç¼–å™¨å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### æ ¸å¿ƒåŠŸèƒ½
- âœ… å®Œæ•´çš„ Layout Passï¼ˆåœ°å€åˆ†é…ã€ç¬¦å·è¡¨ç”Ÿæˆï¼‰
- âœ… å…¨å±€æ ‡ç­¾å’Œå±€éƒ¨æ ‡ç­¾æ”¯æŒï¼ˆ`.` å¼€å¤´çš„å±€éƒ¨æ ‡ç­¾å½’å±æœ€è¿‘çš„å…¨å±€æ ‡ç­¾ï¼‰
- âœ… Section æ”¯æŒï¼ˆ`.text` å’Œ `.data`ï¼‰
- âœ… Directive å¤„ç†ï¼ˆ`.align`, `.byte`, `.word`, `.long`, `.ascii`, `.zero`, `.skip` ç­‰ï¼‰
- âœ… å®Œæ•´çš„æŒ‡ä»¤ç¼–ç ï¼ˆæ”¯æŒæ‰€æœ‰å¯„å­˜å™¨ã€ç«‹å³æ•°å’Œæ ‡ç­¾æ“ä½œæ•°ï¼‰
- âœ… PC ç›¸å¯¹è·³è½¬ï¼ˆSJMP çš„æ­£ç¡®åç§»é‡è®¡ç®—ï¼‰
- âœ… Listing ç”Ÿæˆï¼ˆshow-encoding æ ¼å¼ï¼Œæ˜¾ç¤ºåœ°å€å’Œæœºå™¨ç ï¼‰

### æ•°æ®ç»“æ„
- âœ… `Address` (u32)
- âœ… `Section` (Text/Data)
- âœ… `SymbolTable` (å…¨å±€/å±€éƒ¨æ ‡ç­¾æ˜ å°„)
- âœ… `Layout` (åœ°å€æ˜ å°„ã€ç¬¦å·è¡¨ã€section å¤§å°)
- âœ… `Encoder` (æœºå™¨ç ç”Ÿæˆ)
- âœ… `Listing` (å¯è¯»æ ¼å¼è¾“å‡º)

### CLI å·¥å…·
- âœ… `sayoasm` - å‘½ä»¤è¡Œæ±‡ç¼–å™¨
  - è¾“å…¥ï¼š`.s` æ±‡ç¼–æ–‡ä»¶
  - è¾“å‡ºï¼š`.bin` äºŒè¿›åˆ¶æ–‡ä»¶ + `.lst` listing æ–‡ä»¶

## ğŸ¯ æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹
1. **test_simple.s** - åŸºæœ¬æŒ‡ä»¤æµ‹è¯•
   - MOV8, ADD8, RET
   - éªŒè¯ï¼šâœ… ç¼–ç æ­£ç¡®

2. **test_jump.s** - è·³è½¬æŒ‡ä»¤æµ‹è¯•
   - SJMP å¸¦æ ‡ç­¾
   - PC ç›¸å¯¹åç§»è®¡ç®—
   - éªŒè¯ï¼šâœ… åç§»é‡è®¡ç®—æ­£ç¡®ï¼ˆ-7 ç¼–ç ä¸º 0xF9ï¼‰

### éªŒè¯ç»“æœ

#### test_jump.s ç”Ÿæˆçš„æœºå™¨ç 
```
00000000   6F 04 00 73 04 01 06 64 03 F9 55
           â”‚        â”‚        â”‚     â”‚     â”‚
           â”‚        â”‚        â”‚     â”‚     â””â”€ RET (0x55)
           â”‚        â”‚        â”‚     â””â”€â”€â”€â”€â”€â”€â”€ SJMP -7 (0x03 0xF9)
           â”‚        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SLEEP 100 (0x06 0x64)
           â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ADD8 R0, 1 (0x73 0x04 0x01)
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MOV8 R0, 0 (0x6F 0x04 0x00)
```

#### åœ°å€æ˜ å°„
```
0x0000: main (label)
0x0000: MOV8 R0, 0
0x0003: loop (label)
0x0003: ADD8 R0, 1
0x0006: SLEEP 100
0x0008: SJMP loop    (ç›®æ ‡ 0x0003, ä¸‹ä¸€æ¡ 0x000A, åç§» = 0x0003 - 0x000A = -7)
0x000A: RET
```

## ğŸ“ ä»£ç ç»“æ„

```
crates/
â”œâ”€â”€ sayo_assembler/          # æ±‡ç¼–å™¨æ ¸å¿ƒåº“
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib.rs           # ä¸»å…¥å£ã€Assembler ç»“æ„
â”‚   â”‚   â”œâ”€â”€ address.rs       # Addressã€Section å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ symbol.rs        # SymbolTable å®ç°
â”‚   â”‚   â”œâ”€â”€ layout.rs        # Layout Passï¼ˆåœ°å€åˆ†é…ï¼‰
â”‚   â”‚   â”œâ”€â”€ encoder.rs       # Encoderï¼ˆæœºå™¨ç ç”Ÿæˆï¼‰
â”‚   â”‚   â””â”€â”€ listing.rs       # Listing ç”Ÿæˆ
â”‚   â””â”€â”€ Cargo.toml
â”‚
â””â”€â”€ sayoasm/                 # CLI å·¥å…·
    â”œâ”€â”€ src/
    â”‚   â””â”€â”€ main.rs          # å‘½ä»¤è¡Œæ¥å£
    â””â”€â”€ Cargo.toml
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ ‡ç­¾è§£æè§„åˆ™
- å…¨å±€æ ‡ç­¾ï¼šä¸å¸¦ `.` å‰ç¼€ï¼Œä¾‹å¦‚ `main`, `loop`
- å±€éƒ¨æ ‡ç­¾ï¼šå¸¦ `.` å‰ç¼€ï¼Œä¾‹å¦‚ `.LBB0_1`, `.Lfunc_end0`
- å±€éƒ¨æ ‡ç­¾ä½œç”¨åŸŸï¼šå½’å±æœ€è¿‘å‡ºç°çš„å…¨å±€æ ‡ç­¾

### PC ç›¸å¯¹è·³è½¬è®¡ç®—
```rust
// SJMP: PC-relative I8 offset
let next_pc = instr_addr + instruction_length;
let offset = target_addr - next_pc;
// offset èŒƒå›´ï¼š-128 åˆ° +127
```

### Operand ç±»å‹å¤„ç†
- `Register` â†’ å¯„å­˜å™¨ç¼–ç ï¼ˆä» metadata è·å– indexï¼‰
- `Immediate` â†’ ç›´æ¥å€¼
- `Label` â†’ è§£æä¸ºåœ°å€
  - å¯¹äº SJMP/åˆ†æ”¯æŒ‡ä»¤ï¼šè‡ªåŠ¨è®¡ç®— PC ç›¸å¯¹åç§»
  - å¯¹äºå…¶ä»–æŒ‡ä»¤ï¼šä½¿ç”¨ç»å¯¹åœ°å€

### Directive å¤„ç†
- `.text` / `.data` â†’ åˆ‡æ¢ section
- `.align N` â†’ å¯¹é½åˆ° N å­—èŠ‚è¾¹ç•Œ
- `.byte/.word/.long` â†’ æ•°æ®å®šä¹‰ï¼ˆ1/2/4 å­—èŠ‚ï¼‰
- `.ascii` â†’ å­—ç¬¦ä¸²
- `.zero/.skip` â†’ å¡«å……å­—èŠ‚

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆå¿…éœ€åŠŸèƒ½ï¼‰
- [ ] æ”¯æŒæ›´å¤šè·³è½¬æŒ‡ä»¤çš„ PC ç›¸å¯¹ç¼–ç ï¼ˆJZ, JNZ, CALL ç­‰ï¼‰
- [ ] å®Œå–„é”™è¯¯æŠ¥å‘Šï¼ˆæ˜¾ç¤ºæºæ–‡ä»¶ä½ç½®ï¼‰
- [ ] æ”¯æŒè¡¨è¾¾å¼ï¼ˆ`.long label_end - label_start`ï¼‰

### ä¸­æœŸï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
- [ ] å¤š pass æ”¯æŒï¼ˆforward referenceï¼‰
- [ ] Relocation å’Œ fixup
- [ ] ä¼˜åŒ–ï¼šæ­»ä»£ç æ£€æµ‹ã€unreachable åˆ†æ

### é•¿æœŸï¼ˆVS Code é›†æˆï¼‰
- [ ] LSP é›†æˆï¼šåœ°å€ inlay hints
- [ ] è·³è½¬ç®­å¤´ï¼ˆbranch target visualizationï¼‰
- [ ] CFG å¯è§†åŒ–
- [ ] å®æ—¶ç¼–ç é¢„è§ˆ

## ğŸ“ å‚è€ƒ

- è®¾è®¡æ–‡æ¡£ï¼š`docs/assembler_mvp_plan.md`
- æŒ‡ä»¤é›†å®šä¹‰ï¼š`crates/sayo_ast/src/instr.rs`
- å¯„å­˜å™¨å®šä¹‰ï¼š`crates/sayo_ast/src/reg.rs`
