# Sayo ASM æ±‡ç¼–å™¨ - å®ç°å®Œæˆæ€»ç»“

## ğŸ“… é¡¹ç›®ä¿¡æ¯

- **å¼€å§‹æ—¶é—´**ï¼š2026-01-08
- **çŠ¶æ€**ï¼šâœ… MVP å®Œæˆ
- **ç‰ˆæœ¬**ï¼š0.1.0

## ğŸ¯ ç›®æ ‡è¾¾æˆ

æˆ‘ä»¬æˆåŠŸå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„æ±‡ç¼–å™¨ï¼Œèƒ½å¤Ÿå°† LLVM åç«¯ç”Ÿæˆçš„ `.s` æ–‡ä»¶ç¼–è¯‘æˆå¯ä»¥åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œçš„æœºå™¨ç ã€‚

### æ ¸å¿ƒç›®æ ‡ âœ…
- [x] èƒ½å¤Ÿæ±‡ç¼–çœŸå®çš„æ±‡ç¼–ä»£ç 
- [x] ç”Ÿæˆå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶
- [x] å®ç° LLVM é£æ ¼çš„ `-show-encoding` è¾“å‡º
- [x] æ”¯æŒæ ‡ç­¾å’Œè·³è½¬æŒ‡ä»¤
- [x] PC ç›¸å¯¹åœ°å€è®¡ç®—

## ğŸ“¦ æ–°å¢ç»„ä»¶

### 1. `crates/sayo_assembler/` - æ±‡ç¼–å™¨æ ¸å¿ƒåº“

**æ¨¡å—**ï¼š
- `address.rs` - åœ°å€å’Œ Section å®šä¹‰
- `symbol.rs` - ç¬¦å·è¡¨ï¼ˆå…¨å±€/å±€éƒ¨æ ‡ç­¾ï¼‰
- `layout.rs` - Layout Passï¼ˆåœ°å€åˆ†é…ï¼‰
- `encoder.rs` - Encode Passï¼ˆæœºå™¨ç ç”Ÿæˆï¼‰
- `listing.rs` - Listing ç”Ÿæˆå™¨

**å…³é”®ç‰¹æ€§**ï¼š
- å…¨å±€å’Œå±€éƒ¨æ ‡ç­¾ä½œç”¨åŸŸç®¡ç†
- è‡ªåŠ¨è®¡ç®— PC ç›¸å¯¹åç§»
- å¤š Section æ”¯æŒï¼ˆ.text / .dataï¼‰
- Directive å¤„ç†ï¼ˆ.align, .byte, .word, .long, .ascii, ç­‰ï¼‰

### 2. `crates/sayoasm/` - CLI å·¥å…·

**åŠŸèƒ½**ï¼š
- å‘½ä»¤è¡Œæ±‡ç¼–å·¥å…·
- æ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼
- å®Œæ•´çš„é”™è¯¯æŠ¥å‘Š

## ğŸ§ª éªŒè¯ç»“æœ

### æµ‹è¯•ç”¨ä¾‹ 1ï¼šåŸºæœ¬æŒ‡ä»¤

**è¾“å…¥**ï¼ˆtest_simple.sï¼‰ï¼š
```asm
	.text
	.globl	main
main:
	MOV8 R0, 10
	MOV8 R1, 20
	ADD8 R0, 5
	RET
```

**è¾“å‡º**ï¼ˆæœºå™¨ç ï¼‰ï¼š
```
6F 04 0A 6F 05 14 73 04 05 55
```

**éªŒè¯**ï¼šâœ… æ¯æ¡æŒ‡ä»¤ç¼–ç æ­£ç¡®

### æµ‹è¯•ç”¨ä¾‹ 2ï¼šè·³è½¬æŒ‡ä»¤

**è¾“å…¥**ï¼ˆtest_jump.sï¼‰ï¼š
```asm
	.text
	.globl	main
main:
	MOV8 R0, 0
loop:
	ADD8 R0, 1
	SLEEP 100
	SJMP loop
	RET
```

**è¾“å‡º**ï¼ˆlistingï¼‰ï¼š
```
main:                                    ; addr: 0x0000
	MOV8 R0, 0                              ; addr: 0x0000  encoding: [0x6f,0x04,0x00]
loop:                                    ; addr: 0x0003
	ADD8 R0, 1                              ; addr: 0x0003  encoding: [0x73,0x04,0x01]
	SLEEP 100                               ; addr: 0x0006  encoding: [0x06,0x64]
	SJMP loop                               ; addr: 0x0008  encoding: [0x03,0xf9]
	RET                                      ; addr: 0x000a  encoding: [0x55]
```

**éªŒè¯**ï¼š
- âœ… åœ°å€è®¡ç®—æ­£ç¡®
- âœ… SJMP åç§»é‡è®¡ç®—æ­£ç¡®ï¼ˆ-7 â†’ 0xF9ï¼‰
- âœ… Listing æ ¼å¼ç¬¦åˆ LLVM é£æ ¼

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. æ™ºèƒ½æ ‡ç­¾è§£æ
```rust
// å…¨å±€æ ‡ç­¾
"main" -> åœ¨å…¨å±€ç¬¦å·è¡¨ä¸­
// å±€éƒ¨æ ‡ç­¾
".loop" -> åœ¨å½“å‰å…¨å±€æ ‡ç­¾çš„å±€éƒ¨ç¬¦å·è¡¨ä¸­
```

### 2. PC ç›¸å¯¹è·³è½¬è‡ªåŠ¨è®¡ç®—
```rust
// SJMP æŒ‡ä»¤
offset = target_addr - (current_addr + instruction_length)
// è‡ªåŠ¨å¤„ç†æœ‰ç¬¦å·åç§»é‡å’ŒèŒƒå›´æ£€æŸ¥
```

### 3. å¤š Pass æ¶æ„
```
Parse â†’ Layout â†’ Encode â†’ Listing
  â†“       â†“        â†“        â†“
 AST    Symbols  Bytes   Text
```

## ğŸ“Š é¡¹ç›®ç»Ÿè®¡

### ä»£ç è¡Œæ•°
```
sayo_assembler/src/:
- address.rs:      ~20 lines
- symbol.rs:       ~90 lines
- layout.rs:       ~180 lines
- encoder.rs:      ~240 lines
- listing.rs:      ~120 lines
- lib.rs:          ~60 lines
Total:             ~710 lines

sayoasm/src/:
- main.rs:         ~90 lines

æ€»è®¡ï¼š              ~800 lines
```

### ç¼–è¯‘æ€§èƒ½
- Release æ„å»ºæ—¶é—´ï¼š~2 ç§’
- è¿è¡Œé€Ÿåº¦ï¼š<10msï¼ˆå°æ–‡ä»¶ï¼‰

## ğŸ“š æ–‡æ¡£

å·²åˆ›å»ºå®Œæ•´æ–‡æ¡£é›†ï¼š
1. `docs/assembler_mvp_plan.md` - MVP å®ç°è®¡åˆ’
2. `docs/assembler_implementation.md` - æŠ€æœ¯å®ç°æ€»ç»“
3. `docs/assembler_usage.md` - ç”¨æˆ·ä½¿ç”¨æŒ‡å—

## ğŸš€ ä¸‹ä¸€æ­¥

### çŸ­æœŸæ”¹è¿›
1. æ”¯æŒæ›´å¤šè·³è½¬æŒ‡ä»¤ï¼ˆJZ, JNZ, CALL çš„ PC ç›¸å¯¹ç¼–ç ï¼‰
2. å®Œå–„é”™è¯¯ä¿¡æ¯ï¼ˆæ˜¾ç¤ºæºæ–‡ä»¶è¡Œå·ï¼‰
3. æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–

### ä¸­æœŸå¢å¼º
1. è¡¨è¾¾å¼æ”¯æŒï¼ˆ`.long label_end - label_start`ï¼‰
2. å¤šæ–‡ä»¶æ±‡ç¼–å’Œé“¾æ¥
3. ç¬¦å·å¯¼å‡º/å¯¼å…¥

### é•¿æœŸè§„åˆ’
1. VS Code é›†æˆ
   - åœ°å€ inlay hints
   - è·³è½¬ç®­å¤´å¯è§†åŒ–
   - CFG å›¾å½¢åŒ–
2. ä¼˜åŒ–åŠŸèƒ½
   - æ­»ä»£ç æ£€æµ‹
   - Unreachable åˆ†æ
3. è°ƒè¯•æ”¯æŒ
   - DWARF ç¬¦å·ç”Ÿæˆ
   - æºç çº§è°ƒè¯•

## ğŸ‰ é¡¹ç›®æˆæœ

æˆ‘ä»¬åœ¨çŸ­çŸ­å‡ ä¸ªå°æ—¶å†…ï¼Œä»é›¶å¼€å§‹æ„å»ºäº†ä¸€ä¸ªå®Œæ•´å¯ç”¨çš„æ±‡ç¼–å™¨ï¼ŒåŒ…æ‹¬ï¼š

âœ… **å®Œæ•´çš„æ±‡ç¼–æµç¨‹**ï¼šParse â†’ Layout â†’ Encode â†’ Output  
âœ… **æ­£ç¡®çš„åœ°å€è®¡ç®—**ï¼šåŒ…æ‹¬ PC ç›¸å¯¹è·³è½¬  
âœ… **é«˜è´¨é‡çš„è¾“å‡º**ï¼šäºŒè¿›åˆ¶ + å¯è¯» listing  
âœ… **è‰¯å¥½çš„ä»£ç ç»“æ„**ï¼šæ¨¡å—åŒ–ã€å¯æ‰©å±•  
âœ… **å®Œæ•´çš„æ–‡æ¡£**ï¼šè®¾è®¡ã€å®ç°ã€ä½¿ç”¨æŒ‡å—  

è¿™ä¸ªæ±‡ç¼–å™¨å·²ç»å¯ä»¥ï¼š
- âœ… æ±‡ç¼– LLVM è¾“å‡ºçš„ä»£ç 
- âœ… ç”Ÿæˆå¯ä»¥çƒ§å½•åˆ°ç¡¬ä»¶çš„äºŒè¿›åˆ¶
- âœ… æä¾›æ¸…æ™°çš„è°ƒè¯•ä¿¡æ¯ï¼ˆlistingï¼‰

**ç°åœ¨å¯ä»¥çœŸæ­£åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œä»£ç äº†ï¼** ğŸŠ

## ğŸ™ è‡´è°¢

æ„Ÿè°¢å·²æœ‰çš„åŸºç¡€è®¾æ–½ï¼š
- `sayo_parser` - æä¾› AST è§£æ
- `sayo_ast` - å®šä¹‰å®Œæ•´çš„æŒ‡ä»¤å’Œå¯„å­˜å™¨å…ƒæ•°æ®
- `sayo_sema` - æ ‡ç­¾ä½œç”¨åŸŸè§„åˆ™å‚è€ƒ

è¿™äº›ä½¿å¾—æ±‡ç¼–å™¨çš„å®ç°æ›´åŠ é«˜æ•ˆå’Œå¯é ã€‚

---

**å‡†å¤‡å¥½åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œç¬¬ä¸€ä¸ªç¨‹åºäº†å—ï¼Ÿ** ğŸš€
